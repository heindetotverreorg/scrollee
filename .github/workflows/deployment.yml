name: Deploy scrollee to pi
on: 
  push: 
    branches: 
      - main
      - feature/*
  workflow_dispatch:
env:
  REPO: https://github.com/${{ github.repository }}.git
  IMAGE_PATH: ${{ github.repository }}:latest
  IMAGE_NAME: ${{ github.actor }}/scrollee:latest
  USER_NAME: ${{ github.actor }}
jobs: 
  build-image:
    name: Build image
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_NAMESPACE }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: ${{ env.USER_NAME }}/${{ env.IMAGE_PATH }}
          cache-from: type=registry,ref=heindetotverre/scrollee:latest
          cache-to: type=inline
      - name: Restart service
        run: |
          echo "Current images:"
          docker images
          USER=${{ env.USER_NAME }} IMAGE=${{ env.IMAGE_PATH }} docker compose down
          USER=${{ env.USER_NAME }} IMAGE=${{ env.IMAGE_PATH }} docker compose up -d
  # restart-service:
  #   needs: build-image
  #   name: Restart the docker service
  #   runs-on: self-hosted
  #   steps:
  #     - name: Setup ssh
  #       run: |
  #         mkdir -p ~/.ssh
  #         echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
  #         chmod 600 ~/.ssh/id_rsa
  #     - name: Restart service
  #       run: |
  #         ssh -i ~/.ssh/id_rsa ${{ env.USER_NAME }}@${{ secrets.SERVER_HOST }} -p 22 -o ConnectTimeout="10" -o StrictHostKeyChecking=no <<'ENDSSH'
  #         mkdir -p ~/${{ env.IMAGE_NAME }}
  #         cd ~/${{ env.IMAGE_NAME }}
  #         docker compose up -d 
  #         docker system prune -af
  #         ENDSSH
  #   name: Build image
  #   runs-on: self-hosted
  #   steps:
  #     - name: Setup ssh
  #       run: |
  #         mkdir -p ~/.ssh
  #         echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
  #         chmod 600 ~/.ssh/id_rsa
  #     - name: Checkout Code
  #       run: |
  #         ssh ${{ env.USER_NAME }}@${{ secrets.SERVER_HOST }} -p 22 -o ConnectTimeout="10" -o StrictHostKeyChecking=no <<'ENDSSH'
  #         rm -rf ${{ env.IMAGE_NAME }}
  #         mkdir -p ~/${{ env.IMAGE_NAME }}
  #         cd ~/${{ env.IMAGE_NAME }}
  #         git init
  #         git remote add origin ${{ env.REPO }}
  #         git fetch origin
  #         git checkout ${{ github.ref_name }}
  #         ENDSSH
  #     - name: Build image
  #       run: |
  #         ssh ${{ env.USER_NAME }}@${{ secrets.SERVER_HOST }} -p 22 -o ConnectTimeout="10" -o StrictHostKeyChecking=no <<'ENDSSH'
  #         cd ~/${{ env.IMAGE_NAME }}
  #         docker compose down
  #         docker system prune -af
  #         docker build -t ${{ env.IMAGE_PATH }} .
  #         ENDSSH
  # restart-service:
  #   needs: build-image
  #   name: Restart the docker service
  #   runs-on: self-hosted
  #   steps:
  #     - name: Setup ssh
  #       run: |
  #         mkdir -p ~/.ssh
  #         echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
  #         chmod 600 ~/.ssh/id_rsa
  #     - name: Restart service
  #       run: |
  #         ssh ${{ env.USER_NAME }}@${{ secrets.SERVER_HOST }} -p 22 -o ConnectTimeout="10" -o StrictHostKeyChecking=no <<'ENDSSH'
  #         cd ~/${{ env.IMAGE_NAME }}
  #         docker compose up -d
  #         find . -mindepth 1 ! -name 'compose.yml' -exec rm -rf {} +
  #         ENDSSH